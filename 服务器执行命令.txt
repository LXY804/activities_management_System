# 在服务器上执行以下命令

# 方法 1：使用英文名称的脚本（推荐）
cd /var/www/activities_management
chmod +x optimize-nginx.sh
sudo ./optimize-nginx.sh

# 方法 2：如果方法1失败，使用中文文件名（加引号）
cd /var/www/activities_management
chmod +x "优化Nginx配置.sh"
sudo ./"优化Nginx配置.sh"

# 方法 3：如果方法2也失败，使用 bash 直接执行
cd /var/www/activities_management
sudo bash "优化Nginx配置.sh"

# 方法 4：手动执行（如果脚本都失败）
# 1. 备份配置
sudo cp /etc/nginx/sites-available/activities_management /etc/nginx/sites-available/activities_management.backup

# 2. 编辑配置
sudo nano /etc/nginx/sites-available/activities_management

# 3. 找到图片服务配置部分（大约在第 57-74 行），替换为：
#    查找：location ~* ^/uploads/.*\.(jpg|jpeg|png|gif|webp|svg)$
#    替换为以下内容：

    # 上传的图片文件（直接由 Nginx 服务，不经过后端，大幅提升性能）
    location ~* ^/uploads/.*\.(jpg|jpeg|png|gif|webp|svg)$ {
        # 直接服务静态文件，不经过后端代理
        root /var/www/activities_management/backend;
        
        # 允许浏览器缓存图片 30 天，大幅提升加载速度
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
        add_header X-Content-Type-Options "nosniff";
        
        # 启用 sendfile（零拷贝，提升性能）
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        
        # 启用 gzip（对未压缩的图片有效）
        gzip_static on;
        
        # 如果文件不存在，返回 404（不转发到后端）
        try_files $uri =404;
    }

# 4. 保存并退出（Ctrl+O, Enter, Ctrl+X）

# 5. 测试配置
sudo nginx -t

# 6. 如果测试通过，重载 Nginx
sudo systemctl reload nginx

# 7. 重新构建前端
cd /var/www/activities_management/校园活动管理系统
npm run build

