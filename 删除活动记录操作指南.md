# 删除活动记录操作指南

## ⚠️ 重要提示
- **删除前建议先备份数据库**
- 活动表有外键约束，删除活动前需要先删除关联数据
- 建议先在测试环境验证，再在生产环境操作

## 📋 操作步骤

### 1. 连接到 MySQL 数据库

```bash
mysql -u root -p campus_activities
```

输入数据库密码后进入 MySQL 命令行。

### 2. 查看活动列表（确认要删除的记录）

```sql
-- 查看所有活动
SELECT activity_id, activity_name, activity_code, start_time, organizer_id 
FROM activities 
ORDER BY activity_id;

-- 查看特定活动（例如 ID 为 1-10 的活动）
SELECT activity_id, activity_name, activity_code, start_time 
FROM activities 
WHERE activity_id BETWEEN 1 AND 10;
```

### 3. 检查关联数据（重要！）

在删除活动前，需要检查是否有关联数据：

```sql
-- 检查活动报名记录
SELECT COUNT(*) AS apply_count 
FROM user_activity_apply 
WHERE activity_id = 1;  -- 替换为你要删除的活动ID

-- 检查活动评论
SELECT COUNT(*) AS comment_count 
FROM activity_comments 
WHERE activity_id = 1;

-- 检查活动积分规则
SELECT COUNT(*) AS rule_count 
FROM activity_point_rules 
WHERE activity_id = 1;

-- 检查活动日志
SELECT COUNT(*) AS log_count 
FROM activity_logs 
WHERE route LIKE '%/activities/1%';  -- 替换活动ID
```

### 4. 删除单个活动（推荐方式）

**方式一：只删除活动本身（如果有关联数据会失败）**

```sql
-- 删除单个活动（ID 为 1）
DELETE FROM activities WHERE activity_id = 1;

-- 删除多个活动（ID 为 1, 2, 3）
DELETE FROM activities WHERE activity_id IN (1, 2, 3);
```

**方式二：先删除关联数据，再删除活动（安全方式）**

```sql
-- 开始事务
START TRANSACTION;

-- 1. 删除活动报名记录
DELETE FROM user_activity_apply WHERE activity_id = 1;

-- 2. 删除活动评论
DELETE FROM activity_comments WHERE activity_id = 1;

-- 3. 删除活动积分规则
DELETE FROM activity_point_rules WHERE activity_id = 1;

-- 4. 删除活动本身
DELETE FROM activities WHERE activity_id = 1;

-- 提交事务（如果确认无误）
COMMIT;

-- 如果出错，回滚
-- ROLLBACK;
```

### 5. 批量删除活动（谨慎使用）

```sql
-- 删除所有已结束的活动（示例）
START TRANSACTION;

DELETE FROM user_activity_apply 
WHERE activity_id IN (
    SELECT activity_id FROM activities WHERE end_time < NOW()
);

DELETE FROM activity_comments 
WHERE activity_id IN (
    SELECT activity_id FROM activities WHERE end_time < NOW()
);

DELETE FROM activity_point_rules 
WHERE activity_id IN (
    SELECT activity_id FROM activities WHERE end_time < NOW()
);

DELETE FROM activities WHERE end_time < NOW();

COMMIT;
```

### 6. 删除特定条件的活动

```sql
-- 删除某个组织者创建的所有活动
START TRANSACTION;

DELETE FROM user_activity_apply 
WHERE activity_id IN (
    SELECT activity_id FROM activities WHERE organizer_id = 2
);

DELETE FROM activity_comments 
WHERE activity_id IN (
    SELECT activity_id FROM activities WHERE organizer_id = 2
);

DELETE FROM activity_point_rules 
WHERE activity_id IN (
    SELECT activity_id FROM activities WHERE organizer_id = 2
);

DELETE FROM activities WHERE organizer_id = 2;

COMMIT;
```

### 7. 验证删除结果

```sql
-- 确认活动已删除
SELECT COUNT(*) FROM activities WHERE activity_id = 1;

-- 查看剩余活动数量
SELECT COUNT(*) AS total_activities FROM activities;
```

## 🔧 常用 SQL 命令

### 查看表结构
```sql
DESCRIBE activities;
```

### 查看外键约束
```sql
SELECT 
    CONSTRAINT_NAME,
    TABLE_NAME,
    COLUMN_NAME,
    REFERENCED_TABLE_NAME,
    REFERENCED_COLUMN_NAME
FROM information_schema.KEY_COLUMN_USAGE
WHERE TABLE_SCHEMA = 'campus_activities' 
  AND TABLE_NAME = 'activities'
  AND REFERENCED_TABLE_NAME IS NOT NULL;
```

### 退出 MySQL
```sql
EXIT;
```

## ⚡ 快速删除脚本（单行命令）

如果只是删除单个活动且确认没有关联数据：

```bash
mysql -u root -p -e "USE campus_activities; DELETE FROM activities WHERE activity_id = 1;" campus_activities
```

## 📝 注意事项

1. **外键约束**：`activities` 表有外键关联到：
   - `activity_types` (type_id)
   - `colleges` (target_college_id)  
   - `users` (organizer_id)

2. **关联表**：删除活动前需要先删除：
   - `user_activity_apply` (用户报名记录)
   - `activity_comments` (活动评论)
   - `activity_point_rules` (积分规则)

3. **活动日志**：`activity_logs` 表中的记录可以保留（不影响删除）

4. **备份建议**：删除前备份
   ```bash
   mysqldump -u root -p campus_activities activities > activities_backup_$(date +%Y%m%d).sql
   ```

