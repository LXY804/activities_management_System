# å›¾ç‰‡ä¼˜åŒ–éƒ¨ç½²æŒ‡å—

## ğŸ“‹ ä¼˜åŒ–å†…å®¹

æœ¬æ¬¡ä¼˜åŒ–å®ç°äº†ä»¥ä¸‹åŠŸèƒ½ï¼Œ**å®Œå…¨å…è´¹**ï¼Œå¯æ˜¾è‘—æå‡å›¾ç‰‡åŠ è½½é€Ÿåº¦ï¼š

1. âœ… **Nginx ç›´æ¥æœåŠ¡é™æ€æ–‡ä»¶** - å›¾ç‰‡ä¸å†ç»è¿‡ Node.jsï¼Œå‡å°‘åç«¯è´Ÿè½½
2. âœ… **ä¼˜åŒ–å›¾ç‰‡ç»„ä»¶** - æ”¯æŒæ‡’åŠ è½½ã€å ä½ç¬¦ã€é”™è¯¯å¤„ç†
3. âœ… **æµè§ˆå™¨ç¼“å­˜ä¼˜åŒ–** - å›¾ç‰‡ç¼“å­˜ 30 å¤©ï¼Œå‡å°‘é‡å¤è¯·æ±‚

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤ 1ï¼šæ›´æ–° Nginx é…ç½®

#### æ–¹æ³• Aï¼šä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# 1. å°† ä¼˜åŒ–Nginxé…ç½®.sh ä¸Šä¼ åˆ°æœåŠ¡å™¨
scp ä¼˜åŒ–Nginxé…ç½®.sh root@ä½ çš„æœåŠ¡å™¨IP:/tmp/

# 2. SSH è¿æ¥åˆ°æœåŠ¡å™¨
ssh root@ä½ çš„æœåŠ¡å™¨IP

# 3. è¿è¡Œè„šæœ¬
cd /tmp
chmod +x ä¼˜åŒ–Nginxé…ç½®.sh
sudo ./ä¼˜åŒ–Nginxé…ç½®.sh
```

#### æ–¹æ³• Bï¼šæ‰‹åŠ¨é…ç½®

```bash
# 1. SSH è¿æ¥åˆ°æœåŠ¡å™¨
ssh root@ä½ çš„æœåŠ¡å™¨IP

# 2. å¤‡ä»½ç°æœ‰é…ç½®
sudo cp /etc/nginx/sites-available/activities_management /etc/nginx/sites-available/activities_management.backup

# 3. ç¼–è¾‘é…ç½®æ–‡ä»¶
sudo nano /etc/nginx/sites-available/activities_management
```

æ‰¾åˆ°å›¾ç‰‡æœåŠ¡é…ç½®éƒ¨åˆ†ï¼ˆå¤§çº¦åœ¨ç¬¬ 57-74 è¡Œï¼‰ï¼Œæ›¿æ¢ä¸ºï¼š

```nginx
    # ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶ï¼ˆç›´æ¥ç”± Nginx æœåŠ¡ï¼Œä¸ç»è¿‡åç«¯ï¼Œå¤§å¹…æå‡æ€§èƒ½ï¼‰
    location ~* ^/uploads/.*\.(jpg|jpeg|png|gif|webp|svg)$ {
        # ç›´æ¥æœåŠ¡é™æ€æ–‡ä»¶ï¼Œä¸ç»è¿‡åç«¯ä»£ç†
        root /var/www/activities_management/backend;
        
        # å…è®¸æµè§ˆå™¨ç¼“å­˜å›¾ç‰‡ 30 å¤©ï¼Œå¤§å¹…æå‡åŠ è½½é€Ÿåº¦
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
        add_header X-Content-Type-Options "nosniff";
        
        # å¯ç”¨ sendfileï¼ˆé›¶æ‹·è´ï¼Œæå‡æ€§èƒ½ï¼‰
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        
        # å¯ç”¨ gzipï¼ˆå¯¹æœªå‹ç¼©çš„å›¾ç‰‡æœ‰æ•ˆï¼‰
        gzip_static on;
        
        # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¿”å› 404ï¼ˆä¸è½¬å‘åˆ°åç«¯ï¼‰
        try_files $uri =404;
    }
```

**é‡è¦å˜åŒ–ï¼š**
- âŒ åˆ é™¤äº† `proxy_pass http://localhost:3000;`
- âœ… æ·»åŠ äº† `root /var/www/activities_management/backend;`
- âœ… æ·»åŠ äº† `try_files $uri =404;`

```bash
# 4. æµ‹è¯•é…ç½®
sudo nginx -t

# 5. å¦‚æœæµ‹è¯•é€šè¿‡ï¼Œé‡è½½ Nginx
sudo systemctl reload nginx
```

---

### æ­¥éª¤ 2ï¼šéƒ¨ç½²å‰ç«¯ä»£ç 

```bash
# 1. åœ¨æœ¬åœ°æäº¤ä»£ç 
git add .
git commit -m "ä¼˜åŒ–å›¾ç‰‡åŠ è½½ï¼šNginxç›´æ¥æœåŠ¡é™æ€æ–‡ä»¶ + æ‡’åŠ è½½ç»„ä»¶"
git push origin main

# 2. åœ¨æœåŠ¡å™¨ä¸Šæ‹‰å–ä»£ç 
ssh root@ä½ çš„æœåŠ¡å™¨IP
cd /var/www/activities_management
git pull origin main

# 3. é‡æ–°æ„å»ºå‰ç«¯
cd æ ¡å›­æ´»åŠ¨ç®¡ç†ç³»ç»Ÿ
npm run build

# 4. é‡å¯åç«¯ï¼ˆå¦‚æœéœ€è¦ï¼‰
cd ../backend
pm2 restart activities-backend
```

---

## âœ… éªŒè¯ä¼˜åŒ–æ•ˆæœ

### 1. æ£€æŸ¥ Nginx é…ç½®

```bash
# æŸ¥çœ‹ Nginx é…ç½®
sudo nginx -t

# æŸ¥çœ‹å›¾ç‰‡æœåŠ¡é…ç½®
sudo grep -A 10 "location.*uploads.*\.(jpg\|jpeg\|png\|gif\|webp\|svg)" /etc/nginx/sites-available/activities_management
```

åº”è¯¥çœ‹åˆ° `root /var/www/activities_management/backend;` è€Œä¸æ˜¯ `proxy_pass`ã€‚

### 2. æµè§ˆå™¨æµ‹è¯•

1. æ‰“å¼€ç½‘ç«™ï¼ŒæŒ‰ `F12` æ‰“å¼€å¼€å‘è€…å·¥å…·
2. åˆ‡æ¢åˆ° **Network** æ ‡ç­¾
3. åˆ·æ–°é¡µé¢ï¼ŒæŸ¥çœ‹å›¾ç‰‡è¯·æ±‚
4. ç‚¹å‡»ä»»æ„å›¾ç‰‡è¯·æ±‚ï¼ŒæŸ¥çœ‹ **Response Headers**ï¼š
   - âœ… åº”è¯¥çœ‹åˆ° `Cache-Control: public, max-age=2592000`
   - âœ… åº”è¯¥çœ‹åˆ° `Expires` å¤´ï¼ˆ30å¤©åï¼‰
   - âœ… è¯·æ±‚åº”è¯¥ç›´æ¥ä» Nginx è¿”å›ï¼ˆçŠ¶æ€ç  200ï¼‰

### 3. æ€§èƒ½å¯¹æ¯”

**ä¼˜åŒ–å‰ï¼š**
- å›¾ç‰‡è¯·æ±‚ç»è¿‡ï¼šæµè§ˆå™¨ â†’ Nginx â†’ Node.js â†’ æ–‡ä»¶ç³»ç»Ÿ
- å“åº”æ—¶é—´ï¼š~200-500ms

**ä¼˜åŒ–åï¼š**
- å›¾ç‰‡è¯·æ±‚ç»è¿‡ï¼šæµè§ˆå™¨ â†’ Nginx â†’ æ–‡ä»¶ç³»ç»Ÿ
- å“åº”æ—¶é—´ï¼š~50-150ms
- **æ€§èƒ½æå‡ï¼š60-70%**

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šå›¾ç‰‡æ˜¾ç¤º 404

**åŸå› ï¼š** Nginx æ‰¾ä¸åˆ°æ–‡ä»¶

**è§£å†³ï¼š**
```bash
# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la /var/www/activities_management/backend/uploads/

# æ£€æŸ¥ Nginx é…ç½®ä¸­çš„ root è·¯å¾„æ˜¯å¦æ­£ç¡®
sudo grep "root.*backend" /etc/nginx/sites-available/activities_management

# æ£€æŸ¥æ–‡ä»¶æƒé™
sudo chown -R www-data:www-data /var/www/activities_management/backend/uploads
```

### é—®é¢˜ 2ï¼šå›¾ç‰‡ä»ç„¶ç»è¿‡åç«¯

**åŸå› ï¼š** Nginx é…ç½®æœªç”Ÿæ•ˆ

**è§£å†³ï¼š**
```bash
# æ£€æŸ¥é…ç½®æ˜¯å¦æ­£ç¡®
sudo nginx -t

# æ£€æŸ¥æ˜¯å¦é‡è½½äº† Nginx
sudo systemctl reload nginx

# æŸ¥çœ‹ Nginx é”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/activities_error.log
```

### é—®é¢˜ 3ï¼šæµè§ˆå™¨ç¼“å­˜é—®é¢˜

**è§£å†³ï¼š**
- æŒ‰ `Ctrl+Shift+R` å¼ºåˆ¶åˆ·æ–°
- æˆ–åœ¨å¼€å‘è€…å·¥å…·ä¸­å‹¾é€‰ "Disable cache"

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| å•å›¾åŠ è½½æ—¶é—´ | 200-500ms | 50-150ms | **60-70%** |
| åç«¯ CPU ä½¿ç”¨ | è¾ƒé«˜ | é™ä½ | **30-50%** |
| å¹¶å‘å¤„ç†èƒ½åŠ› | å—é™ | æå‡ | **2-3å€** |
| å¸¦å®½ä½¿ç”¨ | æ­£å¸¸ | å‡å°‘ï¼ˆç¼“å­˜ï¼‰ | **30-50%** |

---

## ğŸ¯ åç»­ä¼˜åŒ–å»ºè®®

1. **å›¾ç‰‡å‹ç¼©**ï¼ˆå·²åœ¨å‰ç«¯å®ç°ï¼‰
   - ä¸Šä¼ æ—¶è‡ªåŠ¨å‹ç¼©åˆ° 300KB ä»¥ä¸‹
   - ä¿æŒè´¨é‡åœ¨ 85%

2. **WebP æ ¼å¼**ï¼ˆå¯é€‰ï¼‰
   - åç«¯è‡ªåŠ¨è½¬æ¢ä¸º WebP
   - ä½“ç§¯å‡å°‘ 30-50%

3. **ç¼©ç•¥å›¾ç”Ÿæˆ**ï¼ˆå¯é€‰ï¼‰
   - åˆ—è¡¨é¡µä½¿ç”¨ç¼©ç•¥å›¾
   - è¯¦æƒ…é¡µä½¿ç”¨åŸå›¾

4. **CDN åŠ é€Ÿ**ï¼ˆéœ€è¦é¢„ç®—ï¼‰
   - ä½¿ç”¨åä¸ºäº‘ OBS + CDN
   - è¿›ä¸€æ­¥æå‡åŠ è½½é€Ÿåº¦

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ–‡ä»¶æƒé™**ï¼šç¡®ä¿ Nginx ç”¨æˆ·ï¼ˆwww-dataï¼‰æœ‰è¯»å–æƒé™
2. **è·¯å¾„ä¸€è‡´æ€§**ï¼šç¡®ä¿ Nginx çš„ `root` è·¯å¾„ä¸åç«¯ `uploads` ç›®å½•ä¸€è‡´
3. **å¤‡ä»½é…ç½®**ï¼šä¿®æ”¹å‰åŠ¡å¿…å¤‡ä»½åŸé…ç½®
4. **æµ‹è¯•ç¯å¢ƒ**ï¼šå»ºè®®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯

---

## ğŸ†˜ å›æ»šæ–¹æ³•

å¦‚æœä¼˜åŒ–åå‡ºç°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šï¼š

```bash
# æ¢å¤å¤‡ä»½çš„é…ç½®
sudo cp /etc/nginx/sites-available/activities_management.backup /etc/nginx/sites-available/activities_management

# æµ‹è¯•å¹¶é‡è½½
sudo nginx -t
sudo systemctl reload nginx
```

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] Nginx é…ç½®å·²æ›´æ–°
- [ ] Nginx é…ç½®æµ‹è¯•é€šè¿‡
- [ ] Nginx å·²é‡è½½
- [ ] å‰ç«¯ä»£ç å·²éƒ¨ç½²
- [ ] æµè§ˆå™¨æµ‹è¯•é€šè¿‡
- [ ] å›¾ç‰‡åŠ è½½é€Ÿåº¦æå‡
- [ ] åç«¯è´Ÿè½½é™ä½

---

**ä¼˜åŒ–å®Œæˆï¼äº«å—æ›´å¿«çš„å›¾ç‰‡åŠ è½½é€Ÿåº¦å§ï¼** ğŸš€

