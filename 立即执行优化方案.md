# ç«‹å³æ‰§è¡Œä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ“‹ ä¼˜åŒ–ä»»åŠ¡æ¸…å•

- [x] ä¼˜åŒ– Nginx é…ç½®ï¼ˆç›´æ¥æœåŠ¡å›¾ç‰‡ï¼‰âœ… **å·²å®Œæˆ**
- [ ] å¢åŠ æ•°æ®ç›˜ï¼ˆ10-20GBï¼‰
- [ ] è¿ç§»å›¾ç‰‡åˆ°æ•°æ®ç›˜
- [ ] å‹ç¼©ç°æœ‰å›¾ç‰‡

---

## ğŸš€ æ‰§è¡Œæ­¥éª¤

### æ­¥éª¤ 1ï¼šå¢åŠ æ•°æ®ç›˜ï¼ˆ10-20GBï¼‰

#### 1.1 æ£€æŸ¥å½“å‰ç£ç›˜ä½¿ç”¨æƒ…å†µ

```bash
# æŸ¥çœ‹å½“å‰ç£ç›˜ä½¿ç”¨
df -h

# æŸ¥çœ‹æŒ‚è½½ç‚¹
mount | grep -E "^/dev"

# æŸ¥çœ‹å—è®¾å¤‡
lsblk
```

#### 1.2 åœ¨äº‘æœåŠ¡å™¨æ§åˆ¶å°æ“ä½œ

1. **ç™»å½•äº‘æœåŠ¡å™¨æ§åˆ¶å°**ï¼ˆåä¸ºäº‘/é˜¿é‡Œäº‘/è…¾è®¯äº‘ç­‰ï¼‰
2. **åˆ›å»ºäº‘ç¡¬ç›˜**
   - å®¹é‡ï¼š10-20GB
   - ç±»å‹ï¼šSSDï¼ˆæ¨èï¼‰æˆ–æ™®é€šäº‘ç›˜
   - åŒºåŸŸï¼šä¸æœåŠ¡å™¨ç›¸åŒ
3. **æŒ‚è½½äº‘ç¡¬ç›˜åˆ°æœåŠ¡å™¨**
   - åœ¨æ§åˆ¶å°å°†äº‘ç¡¬ç›˜æŒ‚è½½åˆ°æœåŠ¡å™¨å®ä¾‹
   - è®°å½•è®¾å¤‡åç§°ï¼ˆå¦‚ï¼š`/dev/vdb`ï¼‰

#### 1.3 åœ¨æœåŠ¡å™¨ä¸Šæ ¼å¼åŒ–å¹¶æŒ‚è½½

```bash
# æŸ¥çœ‹æ–°ç£ç›˜ï¼ˆå‡è®¾æ˜¯ /dev/vdbï¼‰
fdisk -l | grep vdb

# æ ¼å¼åŒ–ç£ç›˜ï¼ˆâš ï¸ æ³¨æ„ï¼šä¼šæ¸…ç©ºæ•°æ®ï¼Œç¡®è®¤æ˜¯æ–°ç£ç›˜ï¼‰
mkfs.ext4 /dev/vdb

# åˆ›å»ºæŒ‚è½½ç‚¹
mkdir -p /mnt/data

# æŒ‚è½½ç£ç›˜
mount /dev/vdb /mnt/data

# è®¾ç½®å¼€æœºè‡ªåŠ¨æŒ‚è½½
echo '/dev/vdb /mnt/data ext4 defaults 0 2' >> /etc/fstab

# éªŒè¯æŒ‚è½½
df -h | grep /mnt/data
```

---

### æ­¥éª¤ 2ï¼šè¿ç§»å›¾ç‰‡åˆ°æ•°æ®ç›˜

#### 2.1 åˆ›å»ºæ–°çš„ä¸Šä¼ ç›®å½•ç»“æ„

```bash
# åˆ›å»ºæ–°çš„ä¸Šä¼ ç›®å½•
mkdir -p /mnt/data/uploads/images
mkdir -p /mnt/data/uploads/avatars
mkdir -p /mnt/data/uploads/others

# è®¾ç½®æƒé™
chown -R www-data:www-data /mnt/data/uploads
chmod -R 755 /mnt/data/uploads
```

#### 2.2 è¿ç§»ç°æœ‰å›¾ç‰‡

```bash
# å¤‡ä»½åŸç›®å½•ï¼ˆä»¥é˜²ä¸‡ä¸€ï¼‰
cp -r /var/www/activities_management/backend/uploads /var/www/activities_management/backend/uploads.backup.$(date +%Y%m%d)

# è¿ç§»å›¾ç‰‡ï¼ˆä¿æŒç›®å½•ç»“æ„ï¼‰
rsync -av --progress /var/www/activities_management/backend/uploads/ /mnt/data/uploads/

# éªŒè¯è¿ç§»
du -sh /var/www/activities_management/backend/uploads
du -sh /mnt/data/uploads

# å¦‚æœæ•°æ®ä¸€è‡´ï¼Œåˆ›å»ºè½¯é“¾æ¥
mv /var/www/activities_management/backend/uploads /var/www/activities_management/backend/uploads.old
ln -s /mnt/data/uploads /var/www/activities_management/backend/uploads

# éªŒè¯è½¯é“¾æ¥
ls -la /var/www/activities_management/backend/ | grep uploads
```

#### 2.3 æ›´æ–° Nginx é…ç½®

```bash
# ç¼–è¾‘ Nginx é…ç½®
sudo nano /etc/nginx/sites-available/activities_management
```

æ‰¾åˆ°å›¾ç‰‡æœåŠ¡é…ç½®ï¼Œå°† `root` è·¯å¾„æ›´æ–°ä¸ºï¼š

```nginx
    location ~* ^/uploads/.*\.(jpg|jpeg|png|gif|webp|svg)$ {
        root /mnt/data;  # æ”¹ä¸ºæ•°æ®ç›˜è·¯å¾„
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
        add_header X-Content-Type-Options "nosniff";
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        try_files $uri =404;
    }
```

```bash
# æµ‹è¯•å¹¶é‡è½½
sudo nginx -t
sudo systemctl reload nginx
```

---

### æ­¥éª¤ 3ï¼šå‹ç¼©ç°æœ‰å›¾ç‰‡

#### 3.1 å®‰è£…å›¾ç‰‡å‹ç¼©å·¥å…·

```bash
# å®‰è£… ImageMagickï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼‰
sudo apt update
sudo apt install -y imagemagick

# æˆ–è€…å®‰è£… jpegoptim å’Œ optipngï¼ˆæ›´ä¸“ä¸šï¼‰
sudo apt install -y jpegoptim optipng

# å®‰è£… WebP å·¥å…·ï¼ˆå¯é€‰ï¼Œç”¨äºè½¬æ¢ä¸º WebPï¼‰
sudo apt install -y webp
```

#### 3.2 åˆ›å»ºå‹ç¼©è„šæœ¬

åˆ›å»ºè„šæœ¬æ–‡ä»¶ï¼š`/root/compress_images.sh`

```bash
#!/bin/bash

# å›¾ç‰‡å‹ç¼©è„šæœ¬
# åŠŸèƒ½ï¼šå‹ç¼© /mnt/data/uploads ä¸‹çš„æ‰€æœ‰å›¾ç‰‡

set -e

UPLOAD_DIR="/mnt/data/uploads"
BACKUP_DIR="/mnt/data/uploads.backup.$(date +%Y%m%d_%H%M%S)"
LOG_FILE="/var/log/image_compress.log"

echo "=========================================="
echo "  å›¾ç‰‡å‹ç¼©è„šæœ¬"
echo "=========================================="
echo ""

# æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
if [ ! -d "$UPLOAD_DIR" ]; then
    echo "âŒ é”™è¯¯ï¼šä¸Šä¼ ç›®å½•ä¸å­˜åœ¨: $UPLOAD_DIR"
    exit 1
fi

# å¤‡ä»½åŸæ–‡ä»¶
echo "ğŸ“‹ æ­¥éª¤ 1: å¤‡ä»½åŸæ–‡ä»¶..."
cp -r "$UPLOAD_DIR" "$BACKUP_DIR"
echo "âœ… å¤‡ä»½å®Œæˆ: $BACKUP_DIR"
echo ""

# ç»Ÿè®¡ä¿¡æ¯
TOTAL_FILES=0
COMPRESSED_FILES=0
SAVED_SPACE=0

# å‹ç¼©å‡½æ•°
compress_image() {
    local file="$1"
    local ext="${file##*.}"
    local size_before=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
    
    if [ -z "$size_before" ] || [ "$size_before" -eq 0 ]; then
        return
    fi
    
    case "${ext,,}" in
        jpg|jpeg)
            # JPEG å‹ç¼©ï¼ˆè´¨é‡ 85%ï¼Œä¿ç•™å…ƒæ•°æ®ï¼‰
            jpegoptim --max=85 --strip-all --preserve --force "$file" 2>/dev/null || \
            convert "$file" -quality 85 -strip "$file.tmp" && mv "$file.tmp" "$file"
            ;;
        png)
            # PNG å‹ç¼©ï¼ˆä¼˜åŒ–çº§åˆ« 2ï¼‰
            optipng -o2 -quiet -force "$file" 2>/dev/null || \
            convert "$file" -quality 85 -strip "$file.tmp" && mv "$file.tmp" "$file"
            ;;
        gif)
            # GIF å‹ç¼©
            convert "$file" -strip "$file.tmp" && mv "$file.tmp" "$file"
            ;;
        *)
            return
            ;;
    esac
    
    local size_after=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
    if [ -n "$size_after" ] && [ "$size_after" -lt "$size_before" ]; then
        local saved=$((size_before - size_after))
        COMPRESSED_FILES=$((COMPRESSED_FILES + 1))
        SAVED_SPACE=$((SAVED_SPACE + saved))
        echo "[å‹ç¼©] $file: $(numfmt --to=iec-i --suffix=B $size_before) -> $(numfmt --to=iec-i --suffix=B $size_after) (èŠ‚çœ: $(numfmt --to=iec-i --suffix=B $saved))" | tee -a "$LOG_FILE"
    fi
    
    TOTAL_FILES=$((TOTAL_FILES + 1))
}

# éå†æ‰€æœ‰å›¾ç‰‡æ–‡ä»¶
echo "ğŸ“‹ æ­¥éª¤ 2: å¼€å§‹å‹ç¼©å›¾ç‰‡..."
echo ""

find "$UPLOAD_DIR" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.gif" \) | while read -r file; do
    compress_image "$file"
done

echo ""
echo "=========================================="
echo "  âœ… å‹ç¼©å®Œæˆï¼"
echo "=========================================="
echo ""
echo "ğŸ“Š ç»Ÿè®¡ä¿¡æ¯ï¼š"
echo "  - æ€»æ–‡ä»¶æ•°: $TOTAL_FILES"
echo "  - å·²å‹ç¼©: $COMPRESSED_FILES"
echo "  - èŠ‚çœç©ºé—´: $(numfmt --to=iec-i --suffix=B $SAVED_SPACE 2>/dev/null || echo "${SAVED_SPACE} bytes")"
echo ""
echo "ğŸ“ æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
echo "ğŸ’¾ å¤‡ä»½ç›®å½•: $BACKUP_DIR"
echo ""
```

#### 3.3 æ‰§è¡Œå‹ç¼©

```bash
# åˆ›å»ºè„šæœ¬
sudo nano /root/compress_images.sh
# ç²˜è´´ä¸Šé¢çš„è„šæœ¬å†…å®¹

# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x /root/compress_images.sh

# æ‰§è¡Œå‹ç¼©ï¼ˆå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œå»ºè®®åœ¨ screen æˆ– tmux ä¸­è¿è¡Œï¼‰
screen -S compress
/root/compress_images.sh

# æˆ–è€…åå°è¿è¡Œ
nohup /root/compress_images.sh > /var/log/image_compress.log 2>&1 &

# æŸ¥çœ‹è¿›åº¦
tail -f /var/log/image_compress.log
```

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœé¢„æœŸ

| ä¼˜åŒ–é¡¹ | æ•ˆæœ |
|--------|------|
| æ•°æ®ç›˜åˆ†ç¦» | ç³»ç»Ÿç›˜ç©ºé—´é‡Šæ”¾ï¼Œæ€§èƒ½æå‡ |
| å›¾ç‰‡è¿ç§» | æ›´å¥½çš„å­˜å‚¨ç®¡ç†ï¼Œä¾¿äºæ‰©å±• |
| å›¾ç‰‡å‹ç¼© | æ–‡ä»¶å¤§å°å‡å°‘ 30-50%ï¼ŒåŠ è½½é€Ÿåº¦æå‡ |
| Nginx ä¼˜åŒ– | å›¾ç‰‡åŠ è½½é€Ÿåº¦æå‡ 60-70% |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®å¤‡ä»½**ï¼šè¿ç§»å’Œå‹ç¼©å‰åŠ¡å¿…å¤‡ä»½
2. **ç£ç›˜ç©ºé—´**ï¼šç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´è¿›è¡Œå¤‡ä»½å’Œå‹ç¼©
3. **æ‰§è¡Œæ—¶é—´**ï¼šå‹ç¼©å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œå»ºè®®åœ¨ä½å³°æœŸæ‰§è¡Œ
4. **æµ‹è¯•éªŒè¯**ï¼šæ¯ä¸ªæ­¥éª¤å®Œæˆåéƒ½è¦æµ‹è¯•åŠŸèƒ½æ˜¯å¦æ­£å¸¸

---

## ğŸ” éªŒè¯æ­¥éª¤

### 1. éªŒè¯æ•°æ®ç›˜æŒ‚è½½

```bash
df -h | grep /mnt/data
mount | grep /mnt/data
```

### 2. éªŒè¯å›¾ç‰‡è¿ç§»

```bash
# æ£€æŸ¥è½¯é“¾æ¥
ls -la /var/www/activities_management/backend/uploads

# æ£€æŸ¥æ–‡ä»¶æ•°é‡
find /mnt/data/uploads -type f | wc -l
find /var/www/activities_management/backend/uploads.old -type f | wc -l
```

### 3. éªŒè¯å›¾ç‰‡è®¿é—®

- æ‰“å¼€ç½‘ç«™ï¼Œæ£€æŸ¥å›¾ç‰‡æ˜¯å¦æ­£å¸¸æ˜¾ç¤º
- æŸ¥çœ‹æµè§ˆå™¨ Networkï¼Œç¡®è®¤å›¾ç‰‡ä»æ–°è·¯å¾„åŠ è½½

### 4. éªŒè¯å‹ç¼©æ•ˆæœ

```bash
# æŸ¥çœ‹å‹ç¼©æ—¥å¿—
cat /var/log/image_compress.log | tail -20

# å¯¹æ¯”å‹ç¼©å‰åå¤§å°
du -sh /mnt/data/uploads.backup.*
du -sh /mnt/data/uploads
```

---

## ğŸ†˜ æ•…éšœæ¢å¤

### å¦‚æœè¿ç§»å¤±è´¥

```bash
# æ¢å¤åŸç›®å½•
rm /var/www/activities_management/backend/uploads
mv /var/www/activities_management/backend/uploads.old /var/www/activities_management/backend/uploads

# æ¢å¤ Nginx é…ç½®
sudo nano /etc/nginx/sites-available/activities_management
# å°† root æ”¹å› /var/www/activities_management/backend
sudo nginx -t && sudo systemctl reload nginx
```

### å¦‚æœå‹ç¼©å¤±è´¥

```bash
# æ¢å¤å¤‡ä»½
rm -rf /mnt/data/uploads
mv /mnt/data/uploads.backup.* /mnt/data/uploads
```

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] æ•°æ®ç›˜å·²åˆ›å»ºå¹¶æŒ‚è½½
- [ ] å›¾ç‰‡å·²è¿ç§»åˆ°æ•°æ®ç›˜
- [ ] è½¯é“¾æ¥å·²åˆ›å»º
- [ ] Nginx é…ç½®å·²æ›´æ–°
- [ ] å›¾ç‰‡è®¿é—®æ­£å¸¸
- [ ] å›¾ç‰‡å‹ç¼©å®Œæˆ
- [ ] å‹ç¼©æ•ˆæœéªŒè¯
- [ ] å¤‡ä»½å·²ä¿å­˜

---

**æ‰§è¡Œå®Œæˆåï¼Œå›¾ç‰‡åŠ è½½é€Ÿåº¦å°†å¤§å¹…æå‡ï¼** ğŸš€

