# å›¾ç‰‡åŠ è½½ä¼˜åŒ–æ–¹æ¡ˆï¼ˆçœŸæ­£æœ‰æ•ˆï¼‰

## ğŸ” é—®é¢˜è¯Šæ–­

1. **å›¾ç‰‡æœªå‹ç¼©**ï¼šä¸Šä¼ çš„å›¾ç‰‡ç›´æ¥ä¿å­˜ï¼Œæœ€å¤§5MBï¼Œæ²¡æœ‰å‹ç¼©
2. **æ²¡æœ‰ç¼©ç•¥å›¾**ï¼šåˆ—è¡¨é¡µåŠ è½½å®Œæ•´å¤§å›¾
3. **æ²¡æœ‰WebPè½¬æ¢**ï¼šæ²¡æœ‰ä½¿ç”¨ç°ä»£å›¾ç‰‡æ ¼å¼
4. **Nginxé…ç½®å¯èƒ½æœªç”Ÿæ•ˆ**ï¼šéœ€è¦éªŒè¯

## âœ… è§£å†³æ–¹æ¡ˆï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

### æ–¹æ¡ˆ1ï¼šåç«¯å›¾ç‰‡å‹ç¼©ï¼ˆæœ€é‡è¦ï¼Œæ•ˆæœæœ€æ˜æ˜¾ï¼‰

**å®‰è£…sharpåº“ï¼ˆé«˜æ€§èƒ½å›¾ç‰‡å¤„ç†ï¼‰**

```bash
cd /var/www/activities_management/backend
npm install sharp
```

**ä¿®æ”¹ä¸Šä¼ ä¸­é—´ä»¶ï¼Œè‡ªåŠ¨å‹ç¼©å›¾ç‰‡**

åˆ›å»º `backend/middleware/imageCompress.js`ï¼š

```javascript
const sharp = require('sharp')
const path = require('path')
const fs = require('fs')

/**
 * å‹ç¼©å›¾ç‰‡ä¸­é—´ä»¶
 * å°†å›¾ç‰‡å‹ç¼©åˆ°åˆç†å¤§å°ï¼ˆåˆ—è¡¨é¡µï¼š800pxå®½ï¼Œè¯¦æƒ…é¡µï¼š1920pxå®½ï¼‰
 */
async function compressImage(inputPath, outputPath, options = {}) {
  const { maxWidth = 1920, quality = 85, format = 'jpeg' } = options
  
  try {
    const metadata = await sharp(inputPath).metadata()
    const width = Math.min(metadata.width, maxWidth)
    
    await sharp(inputPath)
      .resize(width, null, {
        withoutEnlargement: true,
        fit: 'inside'
      })
      .jpeg({ quality }) // æˆ– .webp({ quality })
      .toFile(outputPath)
    
    // åˆ é™¤åŸå›¾ï¼Œä½¿ç”¨å‹ç¼©åçš„å›¾ç‰‡
    if (inputPath !== outputPath) {
      fs.unlinkSync(inputPath)
    }
    
    return true
  } catch (error) {
    console.error('å›¾ç‰‡å‹ç¼©å¤±è´¥:', error)
    return false
  }
}

/**
 * ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆç”¨äºåˆ—è¡¨é¡µï¼‰
 */
async function generateThumbnail(inputPath, outputPath, width = 400) {
  try {
    await sharp(inputPath)
      .resize(width, null, {
        withoutEnlargement: true,
        fit: 'inside'
      })
      .jpeg({ quality: 80 })
      .toFile(outputPath)
    
    return true
  } catch (error) {
    console.error('ç”Ÿæˆç¼©ç•¥å›¾å¤±è´¥:', error)
    return false
  }
}

module.exports = { compressImage, generateThumbnail }
```

**ä¿®æ”¹æ´»åŠ¨ä¸Šä¼ è·¯ç”±** (`backend/routes/events.js`)ï¼š

```javascript
const { compressImage, generateThumbnail } = require('../middleware/imageCompress')
const path = require('path')
const fs = require('fs')

// ä¿®æ”¹ä¸Šä¼ åçš„å¤„ç†
const uploadCover = multer({ 
  storage: coverStorage,
  limits: { fileSize: 5 * 1024 * 1024 },
  fileFilter: (req, file, cb) => {
    if (file.mimetype.startsWith('image/')) {
      cb(null, true)
    } else {
      cb(new Error('åªå…è®¸ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶'), false)
    }
  }
})

// æ·»åŠ å‹ç¼©ä¸­é—´ä»¶
router.post('/', authenticate, authorize('organizer', 'admin'), 
  uploadCover.single('coverImage'),
  async (req, res, next) => {
    if (req.file) {
      const originalPath = req.file.path
      const compressedPath = originalPath.replace(/\.(jpg|jpeg|png)$/i, '_compressed.jpg')
      
      // å‹ç¼©å›¾ç‰‡ï¼ˆæœ€å¤§1920pxå®½ï¼Œç”¨äºè¯¦æƒ…é¡µï¼‰
      const success = await compressImage(originalPath, compressedPath, {
        maxWidth: 1920,
        quality: 85
      })
      
      if (success) {
        // ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆ400pxå®½ï¼Œç”¨äºåˆ—è¡¨é¡µï¼‰
        const thumbnailPath = originalPath.replace(/\.(jpg|jpeg|png)$/i, '_thumb.jpg')
        await generateThumbnail(compressedPath, thumbnailPath, 400)
        
        // æ›´æ–°æ–‡ä»¶è·¯å¾„
        req.file.filename = path.basename(compressedPath)
        req.file.thumbnail = path.basename(thumbnailPath)
      }
    }
    next()
  },
  eventController.createEvent
)
```

### æ–¹æ¡ˆ2ï¼šæ£€æŸ¥å¹¶ä¼˜åŒ–ç°æœ‰å›¾ç‰‡

**æ£€æŸ¥ç°æœ‰å›¾ç‰‡å¤§å°**

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
cd /var/www/activities_management/backend/uploads
find . -type f \( -iname "*.jpg" -o -iname "*.png" \) -exec ls -lh {} \; | awk '{print $5, $9}' | sort -hr | head -20
```

**æ‰¹é‡å‹ç¼©ç°æœ‰å›¾ç‰‡ï¼ˆä¸€æ¬¡æ€§æ“ä½œï¼‰**

åˆ›å»º `backend/scripts/compress-existing-images.js`ï¼š

```javascript
const sharp = require('sharp')
const fs = require('fs')
const path = require('path')

async function compressExistingImages() {
  const uploadsDir = path.join(__dirname, '..', 'uploads')
  const files = fs.readdirSync(uploadsDir, { recursive: true })
  
  let processed = 0
  let saved = 0
  
  for (const file of files) {
    if (!/\.(jpg|jpeg|png)$/i.test(file)) continue
    
    const filePath = path.join(uploadsDir, file)
    const stats = fs.statSync(filePath)
    const originalSize = stats.size
    
    if (originalSize < 100 * 1024) continue // å°äº100KBè·³è¿‡
    
    try {
      const tempPath = filePath + '.tmp'
      await sharp(filePath)
        .resize(1920, null, { withoutEnlargement: true, fit: 'inside' })
        .jpeg({ quality: 85 })
        .toFile(tempPath)
      
      const newSize = fs.statSync(tempPath).size
      if (newSize < originalSize) {
        fs.renameSync(tempPath, filePath)
        saved += (originalSize - newSize)
        console.log(`âœ… ${file}: ${(originalSize/1024).toFixed(0)}KB -> ${(newSize/1024).toFixed(0)}KB`)
      } else {
        fs.unlinkSync(tempPath)
      }
      processed++
    } catch (error) {
      console.error(`âŒ ${file}:`, error.message)
    }
  }
  
  console.log(`\nå¤„ç†å®Œæˆ: ${processed} ä¸ªæ–‡ä»¶ï¼ŒèŠ‚çœ ${(saved/1024/1024).toFixed(2)}MB`)
}

compressExistingImages()
```

æ‰§è¡Œï¼š
```bash
cd /var/www/activities_management/backend
node scripts/compress-existing-images.js
```

### æ–¹æ¡ˆ3ï¼šéªŒè¯Nginxé…ç½®æ˜¯å¦ç”Ÿæ•ˆ

```bash
# æ£€æŸ¥Nginxé…ç½®
sudo nginx -t

# æŸ¥çœ‹å®é™…å“åº”å¤´
curl -I "http://localhost/uploads/cover_xxx.jpg" | grep -E "Cache-Control|Expires|Content-Type"

# åº”è¯¥çœ‹åˆ°ï¼š
# Cache-Control: public, max-age=2592000
# Expires: ... (30å¤©åçš„æ—¥æœŸ)
```

### æ–¹æ¡ˆ4ï¼šå‰ç«¯ä¼˜åŒ–ï¼ˆå·²å®ç°ï¼Œç¡®ä¿éƒ¨ç½²ï¼‰

ç¡®ä¿ `OptimizedImage` ç»„ä»¶å·²éƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼š

```bash
# æ£€æŸ¥å‰ç«¯æ˜¯å¦ä½¿ç”¨äº†OptimizedImage
cd /var/www/activities_management/æ ¡å›­æ´»åŠ¨ç®¡ç†ç³»ç»Ÿ
grep -r "OptimizedImage" src/views/EventList.vue
```

## ğŸš€ å¿«é€Ÿæ‰§è¡Œæ­¥éª¤

### 1. å®‰è£…sharpåº“
```bash
ssh root@124.70.221.193
cd /var/www/activities_management/backend
npm install sharp
```

### 2. åˆ›å»ºå‹ç¼©ä¸­é—´ä»¶
ï¼ˆä½¿ç”¨ä¸Šé¢çš„ä»£ç åˆ›å»º `backend/middleware/imageCompress.js`ï¼‰

### 3. ä¿®æ”¹ä¸Šä¼ è·¯ç”±
ï¼ˆä¿®æ”¹ `backend/routes/events.js`ï¼Œæ·»åŠ ä¸Šé¢çš„å‹ç¼©é€»è¾‘ï¼‰

### 4. é‡å¯æœåŠ¡
```bash
pm2 restart activities-backend
```

### 5. å‹ç¼©ç°æœ‰å›¾ç‰‡ï¼ˆå¯é€‰ä½†æ¨èï¼‰
```bash
cd /var/www/activities_management/backend
node scripts/compress-existing-images.js
```

## ğŸ“Š é¢„æœŸæ•ˆæœ

- **å›¾ç‰‡å¤§å°å‡å°‘ 60-80%**ï¼ˆ5MB -> 500KB-1MBï¼‰
- **åŠ è½½é€Ÿåº¦æå‡ 3-5å€**
- **å¸¦å®½èŠ‚çœ 60-80%**

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **sharpéœ€è¦ç¼–è¯‘**ï¼šå¦‚æœå®‰è£…å¤±è´¥ï¼Œå¯èƒ½éœ€è¦å®‰è£…ç¼–è¯‘å·¥å…·
   ```bash
   sudo apt-get update
   sudo apt-get install -y build-essential
   ```

2. **å†…å­˜ä½¿ç”¨**ï¼šsharpå¤„ç†å¤§å›¾ä¼šå ç”¨å†…å­˜ï¼Œå»ºè®®é™åˆ¶å¹¶å‘

3. **å¤‡ä»½åŸå›¾**ï¼šå‹ç¼©å‰å»ºè®®å¤‡ä»½ï¼ˆå¯é€‰ï¼‰

## ğŸ”§ å¦‚æœsharpå®‰è£…å¤±è´¥

ä½¿ç”¨å¤‡é€‰æ–¹æ¡ˆ `jimp`ï¼ˆçº¯JavaScriptï¼Œæ— éœ€ç¼–è¯‘ï¼‰ï¼š
```bash
npm install jimp
```

ä½†æ€§èƒ½ä¸å¦‚sharpï¼Œå»ºè®®ä¼˜å…ˆä½¿ç”¨sharpã€‚

