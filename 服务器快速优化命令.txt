# æœåŠ¡å™¨å¿«é€Ÿä¼˜åŒ–å‘½ä»¤ - åŠ å¿«æŸ¥è¯¢é€Ÿåº¦

## ğŸš€ ä¸€é”®ä¼˜åŒ–ï¼ˆåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼‰

```bash
cd /var/www/activities_management/backend && \
echo "=== å¼€å§‹ä¼˜åŒ– ===" && \
cp controllers/chatController.js controllers/chatController.js.bak && \
echo "âœ… å·²å¤‡ä»½" && \
echo "æ­£åœ¨ä¼˜åŒ– buildHotActivitiesText..." && \
# ä¼˜åŒ– buildHotActivitiesText - å‡å°‘ limit ä» 5 åˆ° 3
sed -i 's/limit: 5,/limit: 3,/g' controllers/chatController.js && \
# ä¼˜åŒ– buildVolunteerText - å‡å°‘ limit ä» 5 åˆ° 3  
sed -i 's/limit: 5,/limit: 3,/g' controllers/chatController.js && \
# ä¼˜åŒ– buildRecommendText - å‡å°‘ historyRecords limit ä» 50 åˆ° 20
sed -i 's/limit: 50$/limit: 20/g' controllers/chatController.js && \
# ä¼˜åŒ– buildRecommendText - å‡å°‘ topnRecs limit ä» 10 åˆ° 5
sed -i 's/order: \[\[.score., .DESC.\]\],\s*limit: 10/order: [['\''score'\'', '\''DESC'\'']],\n    limit: 5/g' controllers/chatController.js && \
echo "âœ… ä¼˜åŒ–å®Œæˆ" && \
echo "é‡å¯æœåŠ¡..." && \
pm2 restart all --update-env && \
echo "âœ… ä¼˜åŒ–å®Œæˆå¹¶å·²é‡å¯æœåŠ¡"
```

## ğŸ“ æ‰‹åŠ¨ä¼˜åŒ–ï¼ˆæ›´å½»åº•ï¼‰

å¦‚æœéœ€è¦æ›´å½»åº•çš„ä¼˜åŒ–ï¼Œå¯ä»¥æ‰‹åŠ¨ç¼–è¾‘æ–‡ä»¶ï¼š

```bash
cd /var/www/activities_management/backend
nano controllers/chatController.js
```

### ä¼˜åŒ–ç‚¹ 1ï¼šbuildHotActivitiesTextï¼ˆç¬¬ 60-95 è¡Œï¼‰
å°† Sequelize æŸ¥è¯¢æ”¹ä¸ºåŸç”Ÿ SQLï¼š

```javascript
// æ›¿æ¢æ•´ä¸ªå‡½æ•°
async function buildHotActivitiesText() {
  const hotSql = `
    SELECT 
      a.activity_name AS activityName,
      a.start_time AS startTime,
      a.location,
      COUNT(uaa.apply_id) AS cnt
    FROM activities a
    LEFT JOIN user_activity_apply uaa ON a.activity_id = uaa.activity_id 
      AND uaa.apply_status IN (0, 1)
    WHERE a.end_time > NOW()
    GROUP BY a.activity_id, a.activity_name, a.start_time, a.location
    ORDER BY cnt DESC
    LIMIT 3
  `
  const topList = await sequelize.query(hotSql, { type: QueryTypes.SELECT })

  if (!topList.length) return 'æ•°æ®åº“ä¸­æš‚æ—¶æ²¡æœ‰æ´»åŠ¨æŠ¥åæ•°æ®ã€‚'

  return (
    'å½“å‰æŠ¥åäººæ•°æœ€å¤šçš„æ´»åŠ¨ï¼ˆæŒ‰æŠ¥åäººæ•°æ’åºï¼‰ï¼š\n' +
    topList
      .map((r, i) => {
        const name = r.activityName || 'æœªå‘½åæ´»åŠ¨'
        const cnt = r.cnt
        const time = r.startTime || 'æ—¶é—´å¾…å®š'
        const loc = r.location || 'åœ°ç‚¹å¾…å®š'
        return `${i + 1}. ${name}ï¼ˆ${cnt} äººæŠ¥åï¼‰ï¼Œå¼€å§‹æ—¶é—´ï¼š${time}ï¼Œåœ°ç‚¹ï¼š${loc}`
      })
      .join('\n')
  )
}
```

### ä¼˜åŒ–ç‚¹ 2ï¼šbuildVolunteerTextï¼ˆç¬¬ 99-124 è¡Œï¼‰
æ”¹ä¸ºåŸç”Ÿ SQLï¼š

```javascript
async function buildVolunteerText() {
  const volunteerSql = `
    SELECT 
      activity_name AS activityName,
      start_time AS startTime,
      location
    FROM activities
    WHERE activity_name LIKE '%å¿—æ„¿%'
      AND end_time > NOW()
    ORDER BY start_time ASC
    LIMIT 3
  `
  const volunteers = await sequelize.query(volunteerSql, { type: QueryTypes.SELECT })

  if (!volunteers.length) return 'å½“å‰æ²¡æœ‰æŸ¥åˆ°åŒ…å«"å¿—æ„¿"çš„æ´»åŠ¨ï¼Œä½ å¯ä»¥ç¨åå†æ¥çœ‹çœ‹ã€‚'

  return (
    'è¿‘æœŸå’Œ"å¿—æ„¿/ä¹‰å·¥"ç›¸å…³çš„æ´»åŠ¨ï¼š\n' +
    volunteers
      .map((v, i) => {
        const time = v.startTime || 'æ—¶é—´å¾…å®š'
        const loc = v.location || 'åœ°ç‚¹å¾…å®š'
        return `${i + 1}. ${v.activityName}ï¼Œå¼€å§‹æ—¶é—´ï¼š${time}ï¼Œåœ°ç‚¹ï¼š${loc}`
      })
      .join('\n')
  )
}
```

### ä¼˜åŒ–ç‚¹ 3ï¼šbuildRecommendTextï¼ˆç¬¬ 162-413 è¡Œï¼‰
å‡å°‘æŸ¥è¯¢æ•°é‡ï¼š
- ç¬¬ 182 è¡Œï¼š`limit: 10` æ”¹ä¸º `limit: 5`
- ç¬¬ 217 è¡Œï¼š`limit: 50` æ”¹ä¸º `limit: 20`

## âš¡ å¿«é€Ÿä¼˜åŒ–ï¼ˆæœ€ç®€å•ï¼‰

å¦‚æœåªæƒ³å¿«é€Ÿæå‡é€Ÿåº¦ï¼Œåªéœ€å‡å°‘æŸ¥è¯¢æ•°é‡ï¼š

```bash
cd /var/www/activities_management/backend && \
sed -i 's/limit: 5,/limit: 3,/g' controllers/chatController.js && \
sed -i 's/limit: 10$/limit: 5/g' controllers/chatController.js && \
sed -i 's/limit: 50$/limit: 20/g' controllers/chatController.js && \
pm2 restart all --update-env && \
echo "âœ… ä¼˜åŒ–å®Œæˆ"
```

