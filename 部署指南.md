# æ ¡å›­æ´»åŠ¨ç®¡ç†ç³»ç»Ÿ - äº‘æœåŠ¡å™¨éƒ¨ç½²æŒ‡å—

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜å¦‚ä½•å°†æ ¡å›­æ´»åŠ¨ç®¡ç†ç³»ç»Ÿéƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨ä¸Šã€‚

## ğŸ“‹ ç›®å½•

1. [æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡](#1-æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡)
2. [æ•°æ®åº“é…ç½®](#2-æ•°æ®åº“é…ç½®)
3. [åç«¯éƒ¨ç½²](#3-åç«¯éƒ¨ç½²)
4. [å‰ç«¯éƒ¨ç½²](#4-å‰ç«¯éƒ¨ç½²)
5. [ä½¿ç”¨ PM2 ç®¡ç†è¿›ç¨‹](#5-ä½¿ç”¨-pm2-ç®¡ç†è¿›ç¨‹)
6. [ä½¿ç”¨ Nginx ä½œä¸ºåå‘ä»£ç†](#6-ä½¿ç”¨-nginx-ä½œä¸ºåå‘ä»£ç†)
7. [é…ç½® HTTPSï¼ˆå¯é€‰ï¼‰](#7-é…ç½®-httpså¯é€‰)
8. [é˜²ç«å¢™é…ç½®](#8-é˜²ç«å¢™é…ç½®)
9. [å¸¸è§é—®é¢˜æ’æŸ¥](#9-å¸¸è§é—®é¢˜æ’æŸ¥)

---

## 1. æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡

### 1.1 ç³»ç»Ÿè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Ubuntu 20.04+ / CentOS 7+ / Debian 10+
- **Node.js**: >= 20.19.0 æˆ– >= 22.12.0
- **MySQL**: >= 5.7 æˆ– >= 8.0
- **å†…å­˜**: è‡³å°‘ 2GB RAM
- **ç£ç›˜**: è‡³å°‘ 20GB å¯ç”¨ç©ºé—´

### 1.2 å®‰è£… Node.js

#### Ubuntu/Debian:
```bash
# æ›´æ–°ç³»ç»ŸåŒ…
sudo apt update && sudo apt upgrade -y

# å®‰è£… Node.js 20.x
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# éªŒè¯å®‰è£…
node --version
npm --version
```

#### CentOS:
```bash
# å®‰è£… Node.js 20.x
curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
sudo yum install -y nodejs

# éªŒè¯å®‰è£…
node --version
npm --version
```

### 1.3 å®‰è£… MySQL

#### Ubuntu/Debian:
```bash
sudo apt install -y mysql-server
sudo systemctl start mysql
sudo systemctl enable mysql
```

#### CentOS:
```bash
sudo yum install -y mysql-server
sudo systemctl start mysqld
sudo systemctl enable mysqld
```

#### é…ç½® MySQL:
```bash
# è¿è¡Œå®‰å…¨é…ç½®è„šæœ¬
sudo mysql_secure_installation

# ç™»å½• MySQL
sudo mysql -u root -p

# åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·
CREATE DATABASE campus_activities CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'campus_user'@'localhost' IDENTIFIED BY 'your_strong_password';
GRANT ALL PRIVILEGES ON campus_activities.* TO 'campus_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### 1.4 å®‰è£… Nginx

```bash
# Ubuntu/Debian
sudo apt install -y nginx

# CentOS
sudo yum install -y nginx

# å¯åŠ¨å¹¶è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl start nginx
sudo systemctl enable nginx
```

### 1.5 å®‰è£… PM2ï¼ˆè¿›ç¨‹ç®¡ç†å·¥å…·ï¼‰

```bash
sudo npm install -g pm2
```

---

## 2. æ•°æ®åº“é…ç½®

### 2.1 ä¸Šä¼ å¹¶å¯¼å…¥æ•°æ®åº“

```bash
# åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºé¡¹ç›®ç›®å½•
sudo mkdir -p /var/www/activities_management
sudo chown -R $USER:$USER /var/www/activities_management

# ä¸Šä¼ é¡¹ç›®æ–‡ä»¶åˆ°æœåŠ¡å™¨ï¼ˆä½¿ç”¨ scp æˆ– gitï¼‰
# å¦‚æœä½¿ç”¨ git:
cd /var/www/activities_management
git clone <your-repo-url> .

# å¯¼å…¥æ•°æ®åº“
mysql -u campus_user -p campus_activities < backend/database/activity_management.sql
```

### 2.2 éªŒè¯æ•°æ®åº“å¯¼å…¥

```bash
mysql -u campus_user -p campus_activities -e "SHOW TABLES;"
```

---

## 3. åç«¯éƒ¨ç½²

### 3.1 å®‰è£…åç«¯ä¾èµ–

```bash
cd /var/www/activities_management/backend
npm install --production
```

### 3.2 é…ç½®ç¯å¢ƒå˜é‡

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
cd /var/www/activities_management/backend
nano .env
```

æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼ˆæ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼‰ï¼š

```env
# æ•°æ®åº“é…ç½®
DB_HOST=localhost
DB_PORT=3306
DB_NAME=campus_activities
DB_USER=campus_user
DB_PASSWORD=your_strong_password

# JWT é…ç½®
JWT_SECRET=your_very_secure_jwt_secret_key_change_this_in_production
JWT_EXPIRES_IN=7d

# æœåŠ¡å™¨é…ç½®
PORT=3000
NODE_ENV=production

# CORS é…ç½®ï¼ˆæ›¿æ¢ä¸ºä½ çš„åŸŸåï¼‰
CORS_ORIGIN=https://yourdomain.com

# ========== AI å¤§æ¨¡å‹é…ç½®ï¼ˆé‡è¦ï¼ï¼‰==========
# DeepSeek API é…ç½®ï¼ˆç”¨äºèŠå¤©å’Œæ´»åŠ¨æ¨èåŠŸèƒ½ï¼‰
# è·å– API Key: https://platform.deepseek.com/
DEEPSEEK_API_KEY=your_deepseek_api_key_here
DEEPSEEK_MODEL=deepseek-chat

# æ˜Ÿç«å¤§æ¨¡å‹é…ç½®ï¼ˆå¯é€‰ï¼Œå¦‚æœä½¿ç”¨æ˜Ÿç«ï¼‰
# SPARK_APP_ID=your_spark_app_id
# SPARK_API_KEY=your_spark_api_key
# SPARK_API_SECRET=your_spark_api_secret
# SPARK_HOST=spark-api.xf-yun.com
# SPARK_PATH=/v1/x1
# SPARK_MODEL=spark-x
```

**é‡è¦æç¤º**ï¼š
- å°† `JWT_SECRET` æ”¹ä¸ºä¸€ä¸ªå¼ºéšæœºå­—ç¬¦ä¸²
- å°† `CORS_ORIGIN` æ”¹ä¸ºä½ çš„å®é™…åŸŸå
- **å¿…é¡»é…ç½® `DEEPSEEK_API_KEY`**ï¼Œå¦åˆ™ AI èŠå¤©å’Œæ¨èåŠŸèƒ½å°†æ— æ³•ä½¿ç”¨
- ç¡®ä¿ `.env` æ–‡ä»¶æƒé™å®‰å…¨ï¼š`chmod 600 .env`

### 3.3 ä¿®æ”¹åç«¯ CORS é…ç½®

ç¼–è¾‘ `backend/app.js`ï¼Œä¿®æ”¹ CORS é…ç½®ä»¥å…è®¸ç”Ÿäº§åŸŸåï¼š

```javascript
app.use(
  cors({
    origin: (origin, callback) => {
      // å…è®¸çš„åŸŸååˆ—è¡¨
      const allowedOrigins = [
        'https://yourdomain.com',
        'https://www.yourdomain.com',
        process.env.CORS_ORIGIN
      ].filter(Boolean);
      
      if (!origin || allowedOrigins.includes(origin)) {
        return callback(null, true);
      }
      return callback(new Error('Not allowed by CORS'));
    },
    credentials: true
  })
);
```

### 3.4 åˆ›å»ºä¸Šä¼ ç›®å½•

```bash
mkdir -p /var/www/activities_management/backend/uploads
chmod 755 /var/www/activities_management/backend/uploads
```

### 3.5 ä½¿ç”¨ PM2 å¯åŠ¨åç«¯

```bash
cd /var/www/activities_management/backend

# åˆ›å»º PM2 é…ç½®æ–‡ä»¶
cat > ecosystem.config.js << EOF
module.exports = {
  apps: [{
    name: 'activities-backend',
    script: 'app.js',
    instances: 1,
    exec_mode: 'fork',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    merge_logs: true,
    autorestart: true,
    max_memory_restart: '1G'
  }]
}
EOF

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p logs

# å¯åŠ¨åº”ç”¨
pm2 start ecosystem.config.js

# ä¿å­˜ PM2 é…ç½®
pm2 save

# è®¾ç½® PM2 å¼€æœºè‡ªå¯
pm2 startup
# æ‰§è¡Œä¸Šé¢å‘½ä»¤è¾“å‡ºçš„å‘½ä»¤ï¼ˆé€šå¸¸æ˜¯ sudo env PATH=... pm2 startup systemd -u $USER --hp $HOMEï¼‰
```

### 3.6 éªŒè¯åç«¯è¿è¡Œ

```bash
# æŸ¥çœ‹ PM2 çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs activities-backend

# æµ‹è¯• API
curl http://localhost:3000/api/health
```

---

## 4. å‰ç«¯éƒ¨ç½²

### 4.1 å®‰è£…å‰ç«¯ä¾èµ–

```bash
cd /var/www/activities_management/æ ¡å›­æ´»åŠ¨ç®¡ç†ç³»ç»Ÿ
npm install
```

### 4.2 é…ç½®ç¯å¢ƒå˜é‡

åˆ›å»º `.env.production` æ–‡ä»¶ï¼š

```bash
cd /var/www/activities_management/æ ¡å›­æ´»åŠ¨ç®¡ç†ç³»ç»Ÿ
nano .env.production
```

æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼ˆæ›¿æ¢ä¸ºä½ çš„å®é™…åŸŸåï¼‰ï¼š

```env
VITE_API_BASE_URL=https://yourdomain.com/api
```

### 4.3 æ„å»ºå‰ç«¯é¡¹ç›®

```bash
cd /var/www/activities_management/æ ¡å›­æ´»åŠ¨ç®¡ç†ç³»ç»Ÿ
npm run build
```

æ„å»ºå®Œæˆåï¼Œä¼šåœ¨ `dist` ç›®å½•ç”Ÿæˆé™æ€æ–‡ä»¶ã€‚

### 4.4 é…ç½® Nginx æ‰˜ç®¡å‰ç«¯

åˆ›å»º Nginx é…ç½®æ–‡ä»¶ï¼š

```bash
sudo nano /etc/nginx/sites-available/activities_management
```

æ·»åŠ ä»¥ä¸‹é…ç½®ï¼ˆæ›¿æ¢ä¸ºä½ çš„å®é™…åŸŸåå’Œè·¯å¾„ï¼‰ï¼š

```nginx
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;
    
    # å‰ç«¯é™æ€æ–‡ä»¶
    root /var/www/activities_management/æ ¡å›­æ´»åŠ¨ç®¡ç†ç³»ç»Ÿ/dist;
    index index.html;

    # å‰ç«¯è·¯ç”±æ”¯æŒï¼ˆVue Router history æ¨¡å¼ï¼‰
    location / {
        try_files $uri $uri/ /index.html;
    }

    # åç«¯ API ä»£ç†
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # WebSocket æ”¯æŒï¼ˆç”¨äºèŠå¤©åŠŸèƒ½ï¼‰
    location /ws {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶ï¼ˆä¼˜å…ˆåŒ¹é…ï¼Œå…è®¸æµè§ˆå™¨ç¼“å­˜ä»¥æå‡åŠ è½½é€Ÿåº¦ï¼‰
    location ~* ^/uploads/.*\.(jpg|jpeg|png|gif|webp|svg)$ {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # å…è®¸æµè§ˆå™¨ç¼“å­˜å›¾ç‰‡ 30 å¤©ï¼Œå¤§å¹…æå‡åŠ è½½é€Ÿåº¦
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
        add_header X-Content-Type-Options "nosniff";
        
        # å¯ç”¨ sendfile å’Œä¼˜åŒ–
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }

    # å…¶ä»–ä¸Šä¼ æ–‡ä»¶ï¼ˆä¸ç¼“å­˜ï¼‰
    location ^~ /uploads {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # é™æ€èµ„æºç¼“å­˜ï¼ˆ^~ å‰ç¼€ä¼šé˜»æ­¢æ­¤è§„åˆ™åŒ¹é… /uploads è·¯å¾„ï¼‰
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # æ—¥å¿—
    access_log /var/log/nginx/activities_access.log;
    error_log /var/log/nginx/activities_error.log;
}
```

å¯ç”¨é…ç½®ï¼š

```bash
# åˆ›å»ºç¬¦å·é“¾æ¥
sudo ln -s /etc/nginx/sites-available/activities_management /etc/nginx/sites-enabled/

# æµ‹è¯• Nginx é…ç½®
sudo nginx -t

# é‡è½½ Nginx
sudo systemctl reload nginx
```

---

## 5. ä½¿ç”¨ PM2 ç®¡ç†è¿›ç¨‹

### 5.1 å¸¸ç”¨ PM2 å‘½ä»¤

```bash
# æŸ¥çœ‹æ‰€æœ‰åº”ç”¨çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs activities-backend

# é‡å¯åº”ç”¨
pm2 restart activities-backend

# åœæ­¢åº”ç”¨
pm2 stop activities-backend

# åˆ é™¤åº”ç”¨
pm2 delete activities-backend

# æŸ¥çœ‹åº”ç”¨è¯¦æƒ…
pm2 show activities-backend

# ç›‘æ§
pm2 monit
```

### 5.2 æ›´æ–°éƒ¨ç½²

å½“éœ€è¦æ›´æ–°ä»£ç æ—¶ï¼š

```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç 
cd /var/www/activities_management
git pull

# 2. æ›´æ–°åç«¯ä¾èµ–ï¼ˆå¦‚æœéœ€è¦ï¼‰
cd backend
npm install --production

# 3. é‡å¯åç«¯
pm2 restart activities-backend

# 4. æ›´æ–°å‰ç«¯
cd ../æ ¡å›­æ´»åŠ¨ç®¡ç†ç³»ç»Ÿ
npm install
npm run build

# 5. é‡è½½ Nginx
sudo systemctl reload nginx
```

---

## 6. ä½¿ç”¨ Nginx ä½œä¸ºåå‘ä»£ç†

Nginx é…ç½®å·²åœ¨ç¬¬ 4.4 èŠ‚ä¸­å®Œæˆã€‚å¦‚æœéœ€è¦è°ƒæ•´ï¼Œå¯ä»¥ä¿®æ”¹ `/etc/nginx/sites-available/activities_management`ã€‚

### 6.1 ä¼˜åŒ– Nginx é…ç½®

å¯ä»¥æ·»åŠ ä»¥ä¸‹ä¼˜åŒ–é…ç½®ï¼š

```nginx
# åœ¨ server å—ä¸­æ·»åŠ 
client_max_body_size 50M;  # å…è®¸ä¸Šä¼ å¤§æ–‡ä»¶
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;
```

---

## 7. é…ç½® HTTPSï¼ˆå¯é€‰ä½†å¼ºçƒˆæ¨èï¼‰

### 7.1 å®‰è£… Certbot

```bash
# Ubuntu/Debian
sudo apt install -y certbot python3-certbot-nginx

# CentOS
sudo yum install -y certbot python3-certbot-nginx
```

### 7.2 è·å– SSL è¯ä¹¦

```bash
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com
```

æŒ‰ç…§æç¤ºå®Œæˆé…ç½®ï¼ŒCertbot ä¼šè‡ªåŠ¨é…ç½® Nginx ä½¿ç”¨ HTTPSã€‚

### 7.3 è‡ªåŠ¨ç»­æœŸ

Certbot ä¼šè‡ªåŠ¨åˆ›å»ºå®šæ—¶ä»»åŠ¡ï¼Œè¯ä¹¦ä¼šåœ¨åˆ°æœŸå‰è‡ªåŠ¨ç»­æœŸã€‚

éªŒè¯è‡ªåŠ¨ç»­æœŸï¼š

```bash
sudo certbot renew --dry-run
```

---

## 8. é˜²ç«å¢™é…ç½®

### 8.1 é…ç½® UFWï¼ˆUbuntu/Debianï¼‰

```bash
# å…è®¸ SSH
sudo ufw allow 22/tcp

# å…è®¸ HTTP
sudo ufw allow 80/tcp

# å…è®¸ HTTPS
sudo ufw allow 443/tcp

# å¯ç”¨é˜²ç«å¢™
sudo ufw enable

# æŸ¥çœ‹çŠ¶æ€
sudo ufw status
```

### 8.2 é…ç½® firewalldï¼ˆCentOSï¼‰

```bash
# å…è®¸ HTTP
sudo firewall-cmd --permanent --add-service=http

# å…è®¸ HTTPS
sudo firewall-cmd --permanent --add-service=https

# é‡è½½é˜²ç«å¢™
sudo firewall-cmd --reload

# æŸ¥çœ‹çŠ¶æ€
sudo firewall-cmd --list-all
```

**æ³¨æ„**ï¼šä¸è¦å¼€æ”¾ 3000 ç«¯å£ï¼Œåç«¯åº”è¯¥åªé€šè¿‡ Nginx è®¿é—®ã€‚

---

## 9. å¸¸è§é—®é¢˜æ’æŸ¥

### 9.1 åç«¯æ— æ³•å¯åŠ¨

```bash
# æ£€æŸ¥ PM2 æ—¥å¿—
pm2 logs activities-backend --lines 100

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
cd /var/www/activities_management/backend
node test-db.js

# æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tlnp | grep 3000
```

### 9.2 å‰ç«¯æ— æ³•è®¿é—®

```bash
# æ£€æŸ¥ Nginx çŠ¶æ€
sudo systemctl status nginx

# æ£€æŸ¥ Nginx é”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/activities_error.log

# æ£€æŸ¥å‰ç«¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la /var/www/activities_management/æ ¡å›­æ´»åŠ¨ç®¡ç†ç³»ç»Ÿ/dist
```

### 9.3 API è¯·æ±‚å¤±è´¥

1. æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œï¼š`pm2 status`
2. æ£€æŸ¥ CORS é…ç½®æ˜¯å¦æ­£ç¡®
3. æ£€æŸ¥ Nginx ä»£ç†é…ç½®
4. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°å’Œç½‘ç»œè¯·æ±‚

### 9.4 æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
mysql -u campus_user -p campus_activities

# æ£€æŸ¥ MySQL æœåŠ¡çŠ¶æ€
sudo systemctl status mysql

# æ£€æŸ¥é˜²ç«å¢™æ˜¯å¦é˜»æ­¢äº†è¿æ¥
```

### 9.5 æ–‡ä»¶ä¸Šä¼ å¤±è´¥æˆ–ä¸Šä¼ æ–‡ä»¶æ— æ³•è®¿é—®

```bash
# æ£€æŸ¥ä¸Šä¼ ç›®å½•æƒé™
ls -la /var/www/activities_management/backend/uploads

# ç¡®ä¿ç›®å½•å¯å†™
chmod 755 /var/www/activities_management/backend/uploads

# æ£€æŸ¥ä¸Šä¼ æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la /var/www/activities_management/backend/uploads/æ–‡ä»¶å.jpg
```

**å¦‚æœå‡ºç° Nginx é”™è¯¯ï¼š`open() "/var/www/activities_management/æ ¡å›­æ´»åŠ¨ç®¡ç†ç³»ç»Ÿ/dist/uploads/xxx.jpg" failed (2: No such file or directory)`**

è¿™æ˜¯å› ä¸º Nginx é…ç½®ä¸­ `/uploads` è·¯å¾„è¢«é™æ€èµ„æºç¼“å­˜è§„åˆ™æ‹¦æˆªäº†ã€‚è§£å†³æ–¹æ³•ï¼š

1. ç¼–è¾‘ Nginx é…ç½®æ–‡ä»¶ï¼š
```bash
sudo nano /etc/nginx/sites-available/activities_management
```

2. ç¡®ä¿ `/uploads` location å—ä½¿ç”¨ `^~` å‰ç¼€ï¼ˆä¼˜å…ˆåŒ¹é…ï¼‰ï¼š
```nginx
# ä¸Šä¼ æ–‡ä»¶ä»£ç†ï¼ˆä½¿ç”¨ ^~ ç¡®ä¿ä¼˜å…ˆåŒ¹é…ï¼‰
location ^~ /uploads {
    proxy_pass http://localhost:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

3. æµ‹è¯•å¹¶é‡è½½é…ç½®ï¼š
```bash
sudo nginx -t
sudo systemctl reload nginx
```

### 9.6 WebSocket è¿æ¥å¤±è´¥

æ£€æŸ¥ Nginx é…ç½®ä¸­çš„ `/ws` ä½ç½®å—æ˜¯å¦æ­£ç¡®é…ç½®äº† WebSocket ä»£ç†ã€‚

### 9.7 å›¾ç‰‡åŠ è½½å¾ˆæ…¢

å›¾ç‰‡åŠ è½½æ…¢å¯èƒ½ç”±ä»¥ä¸‹åŸå› é€ æˆï¼š

#### 1. æ£€æŸ¥å›¾ç‰‡æ–‡ä»¶å¤§å°
```bash
# æŸ¥çœ‹ä¸Šä¼ ç›®å½•ä¸­çš„å›¾ç‰‡å¤§å°
ls -lh /var/www/activities_management/backend/uploads/*.jpg | head -10

# å¦‚æœå›¾ç‰‡è¿‡å¤§ï¼ˆ> 2MBï¼‰ï¼Œå»ºè®®å‹ç¼©
```

#### 2. ä¼˜åŒ– Nginx é…ç½®ï¼ˆå·²åœ¨ä¸Šé¢çš„é…ç½®ä¸­ä¼˜åŒ–ï¼‰
ç¡®ä¿å›¾ç‰‡æ–‡ä»¶å¯ç”¨äº†æµè§ˆå™¨ç¼“å­˜ï¼Œè¿™æ ·å¯ä»¥å¤§å¹…æå‡äºŒæ¬¡åŠ è½½é€Ÿåº¦ã€‚

#### 3. æ£€æŸ¥æœåŠ¡å™¨èµ„æº
```bash
# æŸ¥çœ‹ CPU å’Œå†…å­˜ä½¿ç”¨æƒ…å†µ
top
# æˆ–
htop

# æŸ¥çœ‹ç£ç›˜ I/O
iostat -x 1

# æŸ¥çœ‹ç½‘ç»œå¸¦å®½
iftop
```

#### 4. å›¾ç‰‡ä¼˜åŒ–å»ºè®®

**å‰ç«¯ä¼˜åŒ–**ï¼š
- ä½¿ç”¨å›¾ç‰‡æ‡’åŠ è½½ï¼ˆlazy loadingï¼‰
- ä½¿ç”¨ WebP æ ¼å¼ï¼ˆæ›´å°çš„æ–‡ä»¶å¤§å°ï¼‰
- å‹ç¼©å›¾ç‰‡åå†ä¸Šä¼ 

**æœåŠ¡å™¨ä¼˜åŒ–**ï¼š
- å¦‚æœå›¾ç‰‡æ–‡ä»¶å¾ˆå¤§ï¼Œè€ƒè™‘ä½¿ç”¨ CDN
- å¯ç”¨ HTTP/2ï¼ˆå¦‚æœä½¿ç”¨ HTTPSï¼‰
- æ£€æŸ¥æœåŠ¡å™¨å¸¦å®½æ˜¯å¦å……è¶³

#### 5. æµ‹è¯•å›¾ç‰‡åŠ è½½é€Ÿåº¦
```bash
# æµ‹è¯•å•ä¸ªå›¾ç‰‡çš„å“åº”æ—¶é—´
time curl -o /dev/null -s -w "%{time_total}\n" http://124.70.221.193/uploads/å›¾ç‰‡å.jpg

# æŸ¥çœ‹ Nginx è®¿é—®æ—¥å¿—ä¸­çš„å“åº”æ—¶é—´
sudo tail -f /var/log/nginx/activities_access.log | grep uploads
```

#### 6. å¦‚æœæœåŠ¡å™¨é…ç½®è¾ƒä½
- **æœ€ä½é…ç½®**ï¼š1æ ¸1Gï¼ˆå¯èƒ½è¾ƒæ…¢ï¼‰
- **æ¨èé…ç½®**ï¼š2æ ¸2G æˆ–æ›´é«˜
- **ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
  - ä½¿ç”¨å›¾ç‰‡ CDNï¼ˆå¦‚é˜¿é‡Œäº‘ OSSã€è…¾è®¯äº‘ COSï¼‰
  - å‹ç¼©å›¾ç‰‡æ–‡ä»¶
  - ä½¿ç”¨ WebP æ ¼å¼
  - å¯ç”¨æµè§ˆå™¨ç¼“å­˜ï¼ˆå·²åœ¨é…ç½®ä¸­ä¼˜åŒ–ï¼‰

---

## 10. å®‰å…¨å»ºè®®

1. **å®šæœŸæ›´æ–°ç³»ç»Ÿ**ï¼š
   ```bash
   sudo apt update && sudo apt upgrade -y
   ```

2. **ä½¿ç”¨å¼ºå¯†ç **ï¼šç¡®ä¿æ•°æ®åº“å¯†ç å’Œ JWT_SECRET è¶³å¤Ÿå¼º

3. **é™åˆ¶ SSH è®¿é—®**ï¼šä½¿ç”¨å¯†é’¥è®¤è¯ï¼Œç¦ç”¨å¯†ç ç™»å½•

4. **å®šæœŸå¤‡ä»½æ•°æ®åº“**ï¼š
   ```bash
   # åˆ›å»ºå¤‡ä»½è„šæœ¬
   mysqldump -u campus_user -p campus_activities > backup_$(date +%Y%m%d).sql
   ```

5. **ç›‘æ§æ—¥å¿—**ï¼šå®šæœŸæ£€æŸ¥åº”ç”¨æ—¥å¿—å’Œç³»ç»Ÿæ—¥å¿—

6. **ä½¿ç”¨ç¯å¢ƒå˜é‡**ï¼šä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯

---

## 11. æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å¯ç”¨ Nginx ç¼“å­˜**ï¼šå¯¹é™æ€èµ„æºå¯ç”¨ç¼“å­˜
2. **ä½¿ç”¨ CDN**ï¼šå°†é™æ€èµ„æºæ”¾åˆ° CDN
3. **æ•°æ®åº“ä¼˜åŒ–**ï¼šæ·»åŠ å¿…è¦çš„ç´¢å¼•
4. **å¯ç”¨ Gzip å‹ç¼©**ï¼šå·²åœ¨ Nginx é…ç½®ä¸­å¯ç”¨
5. **ä½¿ç”¨ Redis**ï¼šç¼“å­˜çƒ­ç‚¹æ•°æ®ï¼ˆå¯é€‰ï¼‰

---

## 12. éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] Node.js å’Œ npm å·²å®‰è£…
- [ ] MySQL å·²å®‰è£…å¹¶é…ç½®
- [ ] æ•°æ®åº“å·²åˆ›å»ºå¹¶å¯¼å…¥æ•°æ®
- [ ] åç«¯ `.env` æ–‡ä»¶å·²é…ç½®
- [ ] åç«¯ä¾èµ–å·²å®‰è£…
- [ ] PM2 å·²å®‰è£…å¹¶é…ç½®
- [ ] åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ
- [ ] å‰ç«¯ä¾èµ–å·²å®‰è£…
- [ ] å‰ç«¯å·²æ„å»º
- [ ] Nginx å·²å®‰è£…å¹¶é…ç½®
- [ ] åŸŸå DNS å·²è§£æ
- [ ] é˜²ç«å¢™å·²é…ç½®
- [ ] HTTPS å·²é…ç½®ï¼ˆå¯é€‰ï¼‰
- [ ] æµ‹è¯•æ‰€æœ‰åŠŸèƒ½æ­£å¸¸

---

## 13. å¿«é€Ÿéƒ¨ç½²è„šæœ¬ç¤ºä¾‹

å¯ä»¥åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬ï¼š

```bash
#!/bin/bash
# deploy.sh

echo "å¼€å§‹éƒ¨ç½²æ ¡å›­æ´»åŠ¨ç®¡ç†ç³»ç»Ÿ..."

# æ›´æ–°ä»£ç 
cd /var/www/activities_management
git pull

# æ›´æ–°åç«¯
cd backend
npm install --production
pm2 restart activities-backend

# æ›´æ–°å‰ç«¯
cd ../æ ¡å›­æ´»åŠ¨ç®¡ç†ç³»ç»Ÿ
npm install
npm run build

# é‡è½½ Nginx
sudo systemctl reload nginx

echo "éƒ¨ç½²å®Œæˆï¼"
```

ä½¿ç”¨ï¼š
```bash
chmod +x deploy.sh
./deploy.sh
```

---

## è”ç³»ä¸æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æ—¥å¿—æ–‡ä»¶
2. ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
3. ç½‘ç»œè¿æ¥
4. é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®

ç¥éƒ¨ç½²é¡ºåˆ©ï¼ğŸ‰

